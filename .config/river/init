#!/bin/sh

# --- Startup & Reset ---
pkill -f mascen
pkill -f waybar
pkill -f mako
pkill -f yubikey-touch-detector
# FORCE KILL any existing portals so they restart with the new variables below
killall -q xdg-desktop-portal-wlr
killall -q xdg-desktop-portal
# If using systemd, stop them there too just to be safe
systemctl --user stop xdg-desktop-portal-wlr
systemctl --user stop xdg-desktop-portal

# --- Environment ---
export MOZ_ENABLE_WAYLAND=1
export QT_QPA_PLATFORM="wayland;xcb"
export XDG_CURRENT_DESKTOP="river"
export XDG_SESSION_TYPE="wayland"

# --- Background Apps ---
# We run these directly so the script waits for them to finish before moving on
systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP XDG_SESSION_TYPE DISPLAY QT_QPA_PLATFORM
dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP XDG_SESSION_TYPE DISPLAY QT_QPA_PLATFORM

mako &
yubikey-touch-detector -libnotify &

riverctl spawn "waybar"
riverctl spawn "sh -c 'sleep 1; pkill -SIGUSR1 waybar'"
riverctl spawn "swaybg -i /home/evan/Pictures/wallpapers/kanso.png -m center -c \"#15171c\""
riverctl spawn "/usr/lib/polkit-kde-authentication-agent-1"

# --- Display Configuration (EXACT REFRESH RATE) ---
wlr-randr --output DP-1 --mode 5120x1440@239.998993 --scale 1 --transform normal --adaptive-sync enabled

# --- Input Configuration ---
riverctl set-repeat 50 300
riverctl keyboard-layout -options "caps:none" us

riverctl input pointer-* accel-profile flat
riverctl input pointer-* pointer-accel 0.0
riverctl input pointer-* tap enabled
riverctl input pointer-* natural-scroll disabled

riverctl focus-follows-cursor normal
riverctl set-cursor-warp disabled
riverctl hide-cursor timeout 3000
riverctl xcursor-theme "Bibata-Original-Classic"

# --- Border Settings ---
riverctl rule-add ssd
riverctl background-color 0x002b36
riverctl border-width 2
riverctl border-color-focused 0x417563
riverctl border-color-unfocused 0x00000000

# --- Keybindings ---
mod="Super"

# Core Apps
riverctl map normal $mod Return spawn "foot"
riverctl map normal $mod Space spawn "appdrawer"
riverctl map normal $mod Q close
riverctl map normal $mod+Shift E exit
riverctl map normal $mod+Alt L spawn "swaylock"
riverctl map normal $mod+Shift M spawn "pkill -SIGUSR1 waybar"

# Utility
riverctl map normal $mod P spawn "powermenu"
riverctl map normal $mod B spawn "bgselector"
riverctl map normal $mod O spawn "outputselector"
riverctl map normal $mod E spawn "nautilus"

# Media Keys
for mode in normal locked; do
    riverctl map $mode None XF86AudioRaiseVolume  spawn "volumeosd up"
    riverctl map $mode None XF86AudioLowerVolume  spawn "volumeosd down"
    riverctl map $mode None XF86AudioMute         spawn "volumeosd mute"
    riverctl map $mode None XF86AudioMicMute      spawn "wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle"
    riverctl map $mode None XF86AudioPlay         spawn "playerctl play-pause"
    riverctl map $mode None XF86AudioPrev         spawn "playerctl previous"
    riverctl map $mode None XF86AudioNext         spawn "playerctl next"
done

# Screenshots

# Ensure directory exist
riverctl spawn "mkdir -p ~/Pictures/Screenshots"
# Print: Interactive (Drag selection OR Click window) — saves and copies
riverctl map normal None Print spawn 'grim -g "$(slurp)" - | tee "$HOME/Pictures/Screenshots/Screenshot-$(date +%Y-%m-%d-%H%M%S).png" | wl-copy'
# Ctrl+Print: Full Screen (All monitors) — saves and copies
riverctl map normal Control Print spawn 'grim - | tee "$HOME/Pictures/Screenshots/Screenshot-$(date +%Y-%m-%d-%H%M%S).png" | wl-copy'

# --- Navigation (HJKL) ---

# Focus
riverctl map normal $mod J focus-view next
riverctl map normal $mod K focus-view previous
riverctl map normal $mod L focus-view next
riverctl map normal $mod H focus-view previous

# Move Windows (Swap in stack)
riverctl map normal $mod+Shift J swap next
riverctl map normal $mod+Shift K swap previous
riverctl map normal $mod+Shift L swap next
riverctl map normal $mod+Shift H swap previous

# Floating & Fullscreen
riverctl map normal $mod V toggle-float
riverctl map normal $mod+Shift F toggle-fullscreen

# Tags
for i in $(seq 1 9); do
    tags=$((1 << ($i - 1)))
    riverctl map normal $mod $i set-focused-tags $tags
    riverctl map normal $mod+Shift $i set-view-tags $tags
    riverctl map normal $mod+Control $i toggle-focused-tags $tags
done

# Scratchpad
# Using the 20th tag (2^19) as the scratchpad
scratch_tag=$((1 << 19))
riverctl map normal $mod S toggle-focused-tags $scratch_tag
riverctl map normal $mod+Shift S set-view-tags $scratch_tag

# Mouse
riverctl map-pointer normal $mod BTN_LEFT move-view
riverctl map-pointer normal $mod BTN_RIGHT resize-view
riverctl map-pointer normal $mod BTN_MIDDLE toggle-float


# --- Layout Generator  ---
mascen --master-width 0.5 --gap 20 --inner-gap 10 --smart-gaps false &
riverctl default-layout mascen


# --- Rules ---
all_tags=$(((1 << 32) - 1))
# float and borderless Picture-in-Picture
riverctl rule-add -title "Picture-in-Picture" float
riverctl rule-add -title "Picture-in-Picture" csd
riverctl rule-add -title "Picture-in-Picture" tags $all_tags

riverctl rule-add -app-id "steam_app_*" csd # csd steam games
riverctl rule-add -app-id "gamescope" csd # csd steam games
riverctl rule-add -app-id "gamescope" float

# spawn on right tag
riverctl rule-add -app-id 'steam' -title "Steam" tags 2
riverctl rule-add -app-id 'steam' -title "Friends List" tags 2
riverctl rule-add -app-id 'org.nicotine_plus.Nicotine' tags 4
riverctl rule-add -app-id 'org.mozilla.Thunderbird' tags 8
riverctl rule-add -app-id 'com.borgbase.Vorta' tags 16
riverctl rule-add -app-id 'firefox' tags 1
riverctl rule-add -app-id 'discord' tags 1

# autostart programs
riverctl spawn "firefox"
riverctl spawn "steam"
riverctl spawn "nicotine"
riverctl spawn "discord"
riverctl spawn "vorta"
riverctl spawn "thunderbird"

# boot sound
mpv --quiet ~/.config/media/lovelyboot.ogg
